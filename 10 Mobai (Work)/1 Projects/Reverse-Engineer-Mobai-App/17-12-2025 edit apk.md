
## Here I wanted to try editing the apk itself.

### Tools: 
- **Jadx**: Used to view the source-code almost as it is from the apk. Editing the code is not possible here but gives most accurate de-compilation of the code.
- **apktool**: It's a commandline tool for decompiling and recompiling the apk file

## What happened?

I am able to see the source-code almost as it is from the jadx-gui... 
I can see snippets like: 
```JAVA
final class IntegrityConstants {
    static final String BINARY_BUSYBOX = "busybox";
    static final String BINARY_SU = "su";
    static final String[] knownRootAppsPackages = {"com.noshufou.android.su", "com.noshufou.android.su.elite", "eu.chainfire.supersu", "com.koushikdutta.superuser", "com.thirdparty.superuser", "com.yellowes.su", "com.topjohnwu.magisk", "com.kingroot.kinguser", "com.kingo.root", "com.smedialink.oneclickroot", "com.zhiqupk.root.global", "com.alephzain.framaroot"};
    public static final String[] knownDangerousAppsPackages = {"com.koushikdutta.rommanager", "com.koushikdutta.rommanager.license", "com.dimonvideo.luckypatcher", "com.chelpus.lackypatch", "com.ramdroid.appquarantine", "com.ramdroid.appquarantinepro", "com.android.vending.billing.InAppBillingService.COIN", "com.android.vending.billing.InAppBillingService.LUCK", "com.chelpus.luckypatcher", "com.blackmartalpha", "org.blackmart.market", "com.allinone.free", "com.repodroid.app", "org.creeplays.hack", "com.baseappfull.fwd", "com.zmapp", "com.dv.marketmod.installer", "org.mobilism.android", "com.android.wp.net.log", "com.android.camera.update", "cc.madkite.freedom", "com.solohsu.android.edxp.manager", "org.meowcat.edxposed.manager", "com.xmodgame", "com.cih.game_cih", "com.charles.lpoqasert", "catch_.me_.if_.you_.can_"};
    public static final String[] knownRootCloakingPackages = {"com.devadvance.rootcloak", "com.devadvance.rootcloakplus", "de.robv.android.xposed.installer", "com.saurik.substrate", "com.zachspong.temprootremovejb", "com.amphoras.hidemyroot", "com.amphoras.hidemyrootadfree", "com.formyhm.hiderootPremium", "com.formyhm.hideroot"};
    private static final String[] suPaths = {"/data/local/", "/data/local/bin/", "/data/local/xbin/", "/sbin/", "/su/bin/", "/system/bin/", "/system/bin/.ext/", "/system/bin/failsafe/", "/system/sd/xbin/", "/system/usr/we-need-root/", "/system/xbin/", "/cache/", "/data/", "/dev/"};
    static final String[] pathsThatShouldNotBeWritable = {"/system", "/system/bin", "/system/sbin", "/system/xbin", "/vendor/bin", "/sbin", "/etc"};
    private IntegrityConstants() throws InstantiationException {
        throw new InstantiationException("This class is not for instantiation");
    }
}  
```
and 
```JAVA
private final void runScan(Context context) {
	ArrayList arrayList = new ArrayList();
	arrayList.addAll(checkRoot(context));
	arrayList.addAll(integrityCheckNative());
	if (arrayList.isEmpty()) {
		arrayList.add("No_Root_Detected");
	}
	List<String> listUnmodifiableList = Collections.unmodifiableList(arrayList);
	h5.d(listUnmodifiableList, "unmodifiableList(...)");
	this.flags = listUnmodifiableList;
	this.done = true;
}

public final List<String> snapshot() {
	return this.flags;
}
```


Then, using this as basis I decompiled the app using apktool as follows:
```Bash
apktool d -r app.apk
```
Then edited the `smali` files correspoding to those functions and updated the runScan method by deleting the `addAll` lines.

Then to recompile the apk following steps were followed:
```Bash
# 0. Recompile
apktool b -c .\app_code_dir

# 1. Align the modified original APK
zipalign -v 4 .\recompiled.apk aligned.apk

# 2. Sign it 
apksigner sign --ks my-release-key.keystore --out final.apk aligned.apk

# 3. Verify it
apksigner verify --verbose final.apk

# 4. Install the FINAL signed file
adb install final.apk

```

***INFO: But the app crashes because teh assets are not correctly binded while rebuilding the apk.***

Now there are 2 paths:
1. Either dive more into how to rebuild the apk correctly..
2. Use frida to modify the package name as follows:
```Javascript
// An Easier Way for Frida Users
// You can hide Magisk from the app using a Frida script on the unmodified APK:

Java.perform(function() {
    var PackageManager = Java.use("android.app.ApplicationPackageManager");
    PackageManager.getPackageInfo.overload('java.lang.String', 'int').implementation = function(pkgName, flags) {
        if (pkgName == "com.topjohnwu.magisk") {
            console.log("Hiding Magisk from the app...");
            pkgName = "com.does.not.exist"; 
        }
        return this.getPackageInfo(pkgName, flags);
    };
});
```

# Use this for logcat: 
`adb logcat AndroidRuntime:E *:S`


Also to bypass the common port for frida: 
```Bash
# Instead of directly running the frida server (sf), start it with custom port
./sf -l 0.0.0.0:1337 &
# Forward that port:
adb forward tcp:1337 tcp:1337
# Connect Frida to the hidden port:
frida -H 127.0.0.1:1337 -f com.example.idcheck
```


- **Start server on custom port:** `adb shell "/data/local/tmp/sf -l 0.0.0.0:1337 &"`
- **Forward that port:** `adb forward tcp:1337 tcp:1337`
- **Connect Frida to the hidden port:** `frida -H 127.0.0.1:1337 -f com.example.idcheck`